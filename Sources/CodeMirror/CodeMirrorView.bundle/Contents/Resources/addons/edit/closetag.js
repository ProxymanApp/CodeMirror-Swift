'use strict';(function(g){"object"==typeof exports&&"object"==typeof module?g(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],g):g(CodeMirror)})(function(g){function w(b){if(b.getOption("disableInput"))return g.Pass;for(var f=b.listSelections(),d=[],c=b.getOption("autoCloseTags"),h=0;h<f.length;h++){if(!f[h].empty())return g.Pass;var e=f[h].head,a=b.getTokenAt(e),m=g.innerMode(b.getMode(),a.state),
n=m.state,k=m.mode.xmlCurrentTag&&m.mode.xmlCurrentTag(n),l=k&&k.name;if(!l)return g.Pass;var p="html"==m.mode.configuration,r="object"==typeof c&&c.dontCloseTags||p&&x;p="object"==typeof c&&c.indentTags||p&&y;a.end>e.ch&&(l=l.slice(0,l.length-a.end+e.ch));var t=l.toLowerCase();if(!l||"string"==a.type&&(a.end!=e.ch||!/["']/.test(a.string.charAt(a.string.length-1))||1==a.string.length)||"tag"==a.type&&k.close||a.string.indexOf("/")==e.ch-a.start-1||r&&-1<q(r,t)||u(b,m.mode.xmlCurrentContext&&m.mode.xmlCurrentContext(n)||
[],l,e,!0))return g.Pass;(a="object"==typeof c&&c.emptyTags)&&-1<q(a,l)?d[h]={text:"/>",newPos:g.Pos(e.line,e.ch+2)}:(a=p&&-1<q(p,t),d[h]={indent:a,text:">"+(a?"\n\n":"")+"</"+l+">",newPos:a?g.Pos(e.line+1,0):g.Pos(e.line,e.ch+1)})}c="object"==typeof c&&c.dontIndentOnAutoClose;for(h=f.length-1;0<=h;h--)e=d[h],b.replaceRange(e.text,f[h].head,f[h].anchor,"+insert"),l=b.listSelections().slice(0),l[h]={head:e.newPos,anchor:e.newPos},b.setSelections(l),!c&&e.indent&&(b.indentLine(e.newPos.line,null,!0),
b.indentLine(e.newPos.line+1,null,!0))}function v(b,f){var d=b.listSelections(),c=[],h=f?"/":"</",e=b.getOption("autoCloseTags");e="object"==typeof e&&e.dontIndentOnSlash;for(var a=0;a<d.length;a++){if(!d[a].empty())return g.Pass;var m=d[a].head,n=b.getTokenAt(m),k=g.innerMode(b.getMode(),n.state),l=k.state;if(f&&("string"==n.type||"<"!=n.string.charAt(0)||n.start!=m.ch-1))return g.Pass;var p="xml"!=k.mode.name&&"htmlmixed"==b.getMode().name;if(p&&"javascript"==k.mode.name)k=h+"script";else if(p&&
"css"==k.mode.name)k=h+"style";else{k=k.mode.xmlCurrentContext&&k.mode.xmlCurrentContext(l);l=k.length?k[k.length-1]:"";if(!k||k.length&&u(b,k,l,m))return g.Pass;k=h+l}">"!=b.getLine(m.line).charAt(n.end)&&(k+=">");c[a]=k}b.replaceSelections(c);d=b.listSelections();if(!e)for(a=0;a<d.length;a++)(a==d.length-1||d[a].head.line<d[a+1].head.line)&&b.indentLine(d[a].head.line)}function q(b,f){if(b.indexOf)return b.indexOf(f);for(var d=0,c=b.length;d<c;++d)if(b[d]==f)return d;return-1}function u(b,f,d,c,
h){if(!g.scanForClosingTag)return!1;var e=Math.min(b.lastLine()+1,c.line+500);c=g.scanForClosingTag(b,c,null,e);if(!c||c.tag!=d)return!1;h=h?1:0;for(var a=f.length-1;0<=a;a--)if(f[a]==d)++h;else break;c=c.to;for(a=1;a<h;a++){f=g.scanForClosingTag(b,c,null,e);if(!f||f.tag!=d)return!1;c=f.to}return!0}g.defineOption("autoCloseTags",!1,function(b,f,d){d!=g.Init&&d&&b.removeKeyMap("autoCloseTags");if(f){d={name:"autoCloseTags"};if("object"!=typeof f||!1!==f.whenClosing)d["'/'"]=function(c){c=c.getOption("disableInput")?
g.Pass:v(c,!0);return c};if("object"!=typeof f||!1!==f.whenOpening)d["'>'"]=function(c){return w(c)};b.addKeyMap(d)}});var x="area base br col command embed hr img input keygen link meta param source track wbr".split(" "),y="applet blockquote body button div dl fieldset form frameset h1 h2 h3 h4 h5 h6 head html iframe layer legend object ol p select table ul".split(" ");g.commands.closeTag=function(b){return v(b)}});
