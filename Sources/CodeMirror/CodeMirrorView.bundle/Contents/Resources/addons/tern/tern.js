'use strict';(function(p){"object"==typeof exports&&"object"==typeof module?p(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],p):p(CodeMirror)})(function(p){function J(a,b,c){var d=a.docs[b];d?c(C(a,d)):a.options.getFile?a.options.getFile(b,c):c(null)}function z(a,b,c){for(var d in a.docs){var f=a.docs[d];if(f.doc==b)return f}if(!c)for(c=0;;++c)if(d="[doc"+(c||"")+"]",!a.docs[d]){c=d;break}return a.addDoc(c,b)}function K(a,b){if("string"==typeof b)return a.docs[b];
b instanceof p&&(b=b.getDoc());if(b instanceof p.Doc)return z(a,b)}function V(a,b,c){var d=z(a,b),f=a.cachedArgHints;f&&f.doc==b&&0<=D(f.start,c.to)&&(a.cachedArgHints=null);f=d.changed;null==f&&(d.changed=f={from:c.from.line,to:c.from.line});var g=c.from.line+(c.text.length-1);c.from.line<f.to&&(f.to-=c.to.line-g);g>=f.to&&(f.to=g+1);f.from>c.from.line&&(f.from=c.from.line);b.lineCount()>L&&100<c.to-f.from&&setTimeout(function(){d.changed&&100<d.changed.to-d.changed.from&&M(a,d)},200)}function M(a,
b){a.server.request({files:[{type:"full",name:b.name,text:C(a,b)}]},function(c){c?window.console.error(c):b.changed=null})}function W(a,b,c){a.request(b,{type:"completions",types:!0,docs:!0,urls:!0},function(d,f){if(d)return y(a,b,d);d=[];var g="",e=f.start,k=f.end;'["'==b.getRange(t(e.line,e.ch-2),e)&&'"]'!=b.getRange(k,t(k.line,k.ch+2))&&(g='"]');for(var h=0;h<f.completions.length;++h){var l=f.completions[h],n=X(l.type);f.guess&&(n+=" "+u+"guess");d.push({text:l.name+g,displayText:l.displayName||
l.name,className:n,data:l})}f={from:e,to:k,list:d};var q=null;p.on(f,"close",function(){A(q)});p.on(f,"update",function(){A(q)});p.on(f,"select",function(m,r){A(q);(m=a.options.completionTip?a.options.completionTip(m.data):m.data.doc)&&(q=F(r.parentNode.getBoundingClientRect().right+window.pageXOffset,r.getBoundingClientRect().top+window.pageYOffset,m,b,u+"hint-doc"))});c(f)})}function X(a){a="?"==a?"unknown":"number"==a||"string"==a||"bool"==a?a:/^fn\(/.test(a)?"fn":/^\[/.test(a)?"array":"object";
return u+"completion "+u+"completion-"+a}function N(a,b,c,d,f){a.request(b,d,function(g,e){if(g)return y(a,b,g);if(a.options.typeTip)g=a.options.typeTip(e);else if(g=w("span",null,w("strong",null,e.type||"not found")),e.doc&&g.appendChild(document.createTextNode(" \u2014 "+e.doc)),e.url){g.appendChild(document.createTextNode(" "));var k=g.appendChild(w("a",null,"[docs]"));k.href=e.url;k.target="_blank"}O(b,g,a);f&&f()},c)}function Y(a,b){B(a);if(!b.somethingSelected()){var c=b.getTokenAt(b.getCursor()).state;
c=p.innerMode(b.getMode(),c);if("javascript"==c.mode.name&&(c=c.state.lexical,"call"==c.info)){for(var d,f=c.pos||0,g=b.getOption("tabSize"),e=b.getCursor().line,k=Math.max(0,e-9),h=!1;e>=k;--e){for(var l=b.getLine(e),n=d=0;;){n=l.indexOf("\t",n);if(-1==n)break;d+=g-(n+d)%g-1;n+=1}d=c.column-d;if("("==l.charAt(d)){h=!0;break}}if(h){var q=t(e,d);if((c=a.cachedArgHints)&&c.doc==b.getDoc()&&0==D(q,c.start))return P(a,b,f);a.request(b,{type:"type",preferFunction:!0,end:q},function(m,r){if(!m&&r.type&&
/^fn\(/.test(r.type)){var x=r.type;m=[];var v=3;if(")"!=x.charAt(v))for(;;){var E=x.slice(v).match(/^([^, \(\[\{]+): /);E&&(v+=E[0].length,E=E[1]);var Q=m,Z=Q.push;a:{var G=/[\),]/;for(var H=0,aa=v;;){var I=x.charAt(v);if(G.test(I)&&!H){G=x.slice(aa,v);break a}/[{\[\(]/.test(I)?++H:/[}\]\)]/.test(I)&&--H;++v}}Z.call(Q,{name:E,type:G});if(")"==x.charAt(v))break;v+=2}x=x.slice(v).match(/^\) -> (.*)$/);a.cachedArgHints={start:q,type:{args:m,rettype:x&&x[1]},name:r.exprName||r.name||"fn",guess:r.guess,
doc:b.getDoc()};P(a,b,f)}})}}}}function P(a,b,c){B(a);var d=a.cachedArgHints,f=d.type;d=w("span",d.guess?u+"fhint-guess":null,w("span",u+"fname",d.name),"(");for(var g=0;g<f.args.length;++g){g&&d.appendChild(document.createTextNode(", "));var e=f.args[g];d.appendChild(w("span",u+"farg"+(g==c?" "+u+"farg-current":""),e.name||"?"));"?"!=e.type&&(d.appendChild(document.createTextNode(":\u00a0")),d.appendChild(w("span",u+"type",e.type)))}d.appendChild(document.createTextNode(f.rettype?") ->\u00a0":")"));
f.rettype&&d.appendChild(w("span",u+"type",f.rettype));c=b.cursorCoords(null,"page");var k=a.activeArgHints=F(c.right+1,c.bottom,d,b);setTimeout(function(){k.clear=R(b,function(){a.activeArgHints==k&&B(a)})},20)}function ba(a,b){function c(d){d={type:"definition",variable:d||null};var f=z(a,b.getDoc());a.server.request(S(a,f,d),function(g,e){if(g)return y(a,b,g);if(!e.file&&e.url)window.open(e.url);else{if(e.file){g=a.docs[e.file];var k;if(k=g){var h=g.doc;var l=e.context.slice(0,e.contextOffset).split("\n");
var n=e.start.line-(l.length-1);k=t(n,(1==l.length?e.start.ch:h.getLine(n).length)-l[0].length);var q=h.getLine(n).slice(k.ch);for(n+=1;n<h.lineCount()&&q.length<e.context.length;++n)q+="\n"+h.getLine(n);if(q.slice(0,e.context.length)==e.context)var m=e;else{h=h.getSearchCursor(e.context,0,!1);for(q=Infinity;h.findNext();){n=h.from();var r=1E4*Math.abs(n.line-k.line);r||(r=Math.abs(n.ch-k.ch));r<q&&(m=n,q=r)}m?(1==l.length?m.ch+=l[0].length:m=t(m.line+(l.length-1),l[l.length-1].length),e=e.start.line==
e.end.line?t(m.line,m.ch+(e.end.ch-e.start.ch)):t(m.line+(e.end.line-e.start.line),e.end.ch),m={start:m,end:e}):m=null}k=l=m}if(k){a.jumpStack.push({file:f.name,start:b.getCursor("from"),end:b.getCursor("to")});T(a,f,g,l.start,l.end);return}}y(a,b,"Could not find a definition.")}})}ca(b)?c():U(b,"Jump to variable",function(d){d&&c(d)})}function T(a,b,c,d,f){c.doc.setSelection(d,f);b!=c&&a.options.switchToDoc&&(B(a),a.options.switchToDoc(c.name,c.doc))}function ca(a){var b=a.getCursor("end"),c=a.getTokenAt(b);
return c.start<b.ch&&"comment"==c.type?!1:/[\w)\]]/.test(a.getLine(b.line).slice(Math.max(b.ch-1,0),b.ch+1))}function da(a,b){var c=b.getTokenAt(b.getCursor());if(!/\w/.test(c.string))return y(a,b,"Not at a variable");U(b,"New name for "+c.string,function(d){a.request(b,{type:"rename",newName:d,fullDocs:!0},function(f,g){if(f)return y(a,b,f);ea(a,g.changes)})})}function fa(a,b){var c=z(a,b.doc).name;a.request(b,{type:"refs"},function(d,f){if(d)return y(a,b,d);d=[];for(var g=0,e=b.getCursor(),k=0;k<
f.refs.length;k++){var h=f.refs[k];h.file==c&&(d.push({anchor:h.start,head:h.end}),0<=D(e,h.start)&&0>=D(e,h.end)&&(g=d.length-1))}b.setSelections(d,g)})}function ea(a,b){for(var c=Object.create(null),d=0;d<b.length;++d){var f=b[d];(c[f.file]||(c[f.file]=[])).push(f)}for(var g in c){b=a.docs[g];var e=c[g];if(b){e.sort(function(h,l){return D(l.start,h.start)});var k="*rename"+ ++ha;for(d=0;d<e.length;++d)f=e[d],b.doc.replaceRange(f.text,f.start,f.end,k)}}}function S(a,b,c,d){var f=[],g;(g=!c.fullDocs)||
delete c.fullDocs;"string"==typeof c&&(c={type:c});c.lineCharPositions=!0;null==c.end&&(c.end=d||b.doc.getCursor("end"),b.doc.somethingSelected()&&(c.start=b.doc.getCursor("start")));var e=c.start||c.end;if(b.changed)if(b.doc.lineCount()>L&&!1!==g&&100>b.changed.to-b.changed.from&&b.changed.from<=e.line&&b.changed.to>c.end.line){g=f.push;d=c.end;for(var k=b.doc,h=null,l=null,n=e.line-1,q=Math.max(0,n-50);n>=q;--n){var m=k.getLine(n);0>m.search(/\bfunction\b/)||(m=p.countColumn(m,null,4),null!=h&&
h<=m||(h=m,l=n))}null==l&&(l=q);n=Math.min(k.lastLine(),d.line+20);if(null==h||h==p.countColumn(k.getLine(e.line),null,4))e=n;else for(e=d.line+1;e<n&&!(m=p.countColumn(k.getLine(e),null,4),m<=h);++e);h=t(l,0);d={type:"part",name:b.name,offsetLines:h.line,text:k.getRange(h,t(e,d.line==e?null:0))};g.call(f,d);c.file="#0";g=f[0].offsetLines;null!=c.start&&(c.start=t(c.start.line- -g,c.start.ch));c.end=t(c.end.line-g,c.end.ch)}else f.push({type:"full",name:b.name,text:C(a,b)}),c.file=b.name,b.changed=
null;else c.file=b.name;for(var r in a.docs)g=a.docs[r],g.changed&&g!=b&&(f.push({type:"full",name:g.name,text:C(a,g)}),g.changed=null);return{query:c,files:f}}function w(a,b){var c=document.createElement(a);b&&(c.className=b);for(var d=2;d<arguments.length;++d){var f=arguments[d];"string"==typeof f&&(f=document.createTextNode(f));c.appendChild(f)}return c}function U(a,b,c){a.openDialog?a.openDialog(b+": <input type=text>",c):c(prompt(b,""))}function O(a,b,c){function d(){a.state.ternTooltip=null;
g.parentNode&&ia(g);h()}a.state.ternTooltip&&A(a.state.ternTooltip);var f=a.cursorCoords(),g=a.state.ternTooltip=F(f.right+1,f.bottom,b,a),e=!1,k=!1;p.on(g,"mousemove",function(){e=!0});p.on(g,"mouseout",function(l){(l=l.relatedTarget||l.toElement)&&p.contains(g,l)||(k?d():e=!1)});setTimeout(function(){k=!0;e||d()},c.options.hintDelay?c.options.hintDelay:1700);var h=R(a,d)}function R(a,b){a.on("cursorActivity",b);a.on("blur",b);a.on("scroll",b);a.on("setDoc",b);return function(){a.off("cursorActivity",
b);a.off("blur",b);a.off("scroll",b);a.off("setDoc",b)}}function F(a,b,c,d,f){c=w("div",u+"tooltip "+(f||""),c);c.style.left=a+"px";c.style.top=b+"px";(((d.options||{}).hintOptions||{}).container||document.body).appendChild(c);b=d.cursorCoords();d=window.innerWidth;f=window.innerHeight;var g=c.getBoundingClientRect(),e=document.querySelector(".CodeMirror-hints"),k=g.bottom-f,h=g.right-d;e&&0<h&&(c.style.left=0,g=c.getBoundingClientRect(),c.style.left=(a=a-e.offsetWidth-g.width)+"px",h=g.right-d);
0<k&&(e=g.bottom-g.top,0<b.top-(b.bottom-g.top)-e?c.style.top=b.top-e+"px":e>f&&(c.style.height=f-5+"px",c.style.top=b.bottom-g.top+"px"));0<h&&(g.right-g.left>d&&(c.style.width=d-5+"px",h-=g.right-g.left-d),c.style.left=a-h+"px");return c}function A(a){var b=a&&a.parentNode;b&&b.removeChild(a)}function ia(a){a.style.opacity="0";setTimeout(function(){A(a)},1100)}function y(a,b,c){a.options.showError?a.options.showError(b,c):O(b,String(c),a)}function B(a){a.activeArgHints&&(a.activeArgHints.clear&&
a.activeArgHints.clear(),A(a.activeArgHints),a.activeArgHints=null)}function C(a,b){var c=b.doc.getValue();a.options.fileFilter&&(c=a.options.fileFilter(c,b.name,b.doc));return c}function ja(a){function b(g,e){e&&(g.id=++d,f[d]=e);c.postMessage(g)}var c=a.worker=new Worker(a.options.workerScript);c.postMessage({type:"init",defs:a.options.defs,plugins:a.options.plugins,scripts:a.options.workerDeps});var d=0,f={};c.onmessage=function(g){var e=g.data;"getFile"==e.type?J(a,e.name,function(k,h){b({type:"getFile",
err:String(k),text:h,id:e.id})}):"debug"==e.type?window.console.log(e.message):e.id&&f[e.id]&&(f[e.id](e.err,e.body),delete f[e.id])};c.onerror=function(g){for(var e in f)f[e](g);f={}};this.addFile=function(g,e){b({type:"add",name:g,text:e})};this.delFile=function(g){b({type:"del",name:g})};this.request=function(g,e){b({type:"req",body:g},e)}}p.TernServer=function(a){var b=this;this.options=a||{};a=this.options.plugins||(this.options.plugins={});a.doc_comment||(a.doc_comment=!0);this.docs=Object.create(null);
this.server=this.options.useWorker?new ja(this):new tern.Server({getFile:function(c,d){return J(b,c,d)},async:!0,defs:this.options.defs||[],plugins:a});this.trackChange=function(c,d){V(b,c,d)};this.activeArgHints=this.cachedArgHints=null;this.jumpStack=[];this.getHint=function(c,d){return W(b,c,d)};this.getHint.async=!0};p.TernServer.prototype={addDoc:function(a,b){var c={doc:b,name:a,changed:null};this.server.addFile(a,C(this,c));p.on(b,"change",this.trackChange);return this.docs[a]=c},delDoc:function(a){if(a=
K(this,a))p.off(a.doc,"change",this.trackChange),delete this.docs[a.name],this.server.delFile(a.name)},hideDoc:function(a){B(this);(a=K(this,a))&&a.changed&&M(this,a)},complete:function(a){a.showHint({hint:this.getHint})},showType:function(a,b,c){N(this,a,b,"type",c)},showDocs:function(a,b,c){N(this,a,b,"documentation",c)},updateArgHints:function(a){Y(this,a)},jumpToDef:function(a){ba(this,a)},jumpBack:function(a){var b=this.jumpStack.pop(),c=b&&this.docs[b.file];c&&T(this,z(this,a.getDoc()),c,b.start,
b.end)},rename:function(a){da(this,a)},selectName:function(a){fa(this,a)},request:function(a,b,c,d){var f=this,g=z(this,a.getDoc()),e=S(this,g,b,d);if(a=e.query&&this.options.queryOptions&&this.options.queryOptions[e.query.type])for(var k in a)e.query[k]=a[k];this.server.request(e,function(h,l){!h&&f.options.responseFilter&&(l=f.options.responseFilter(g,b,e,h,l));c(h,l)})},destroy:function(){B(this);this.worker&&(this.worker.terminate(),this.worker=null)}};var t=p.Pos,u="CodeMirror-Tern-",L=250,ha=
0,D=p.cmpPos});
